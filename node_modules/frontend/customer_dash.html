<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Customer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-r from-blue-100 via-indigo-200 to-purple-100 min-h-screen text-gray-800">

  <!-- Navbar -->
  <header class="bg-white/90 backdrop-blur-md shadow-lg p-6 mb-6 sticky top-0 z-10 flex justify-between items-center rounded-b-1xl mt-100px">
    <h1 class="text-3xl font-extrabold text-purple-700 tracking-wide">üè† Flat Listings Dashboard</h1>
    <button onclick="logout()" class="text-red-600 hover:text-red-800 font-semibold transition duration-300">
      Logout
    </button>
  </header>

  <!-- Main Content -->
  <main class="max-w-6xl mx-auto px-4 space-y-10 pb-10">
    <div id="flatsContainer" class="space-y-10"></div>
  </main>

  <!-- Contact Owner Modal -->
  <div id="ownerModal" 
       class="fixed inset-0 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white/95 rounded-3xl shadow-2xl max-w-md w-full p-8 relative">
      <button onclick="closeModal()" 
              class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      <h2 class="text-2xl font-bold text-purple-700 mb-4 border-b pb-2">Owner Details</h2>
      <div id="ownerDetails" class="space-y-2 text-gray-700 text-sm"></div>
      <div class="mt-6 text-right">
        <button onclick="closeModal()" 
                class="px-5 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-medium transition duration-300">Close</button>
      </div>
    </div>
  </div>

  <script>
    function logout() {
      localStorage.removeItem("userId");
      alert("Logged out successfully!");
      window.location.href = "/login.html";
    }

    const userId = localStorage.getItem("userId");
    if (!userId) {
      alert("Please log in to access the dashboard.");
      window.location.href = "/login.html";
    }

    let flatsData = [];

    fetch("/api/flats-details/all-details", {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    })
    .then(response => response.json())
    .then(data => {
      flatsData = data;
      const container = document.getElementById("flatsContainer");
      if (!data || data.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-700">No flats available at the moment. Please check back later.</p>`;
        return;
      }

      data.forEach((flat, index) => {
        const owner = flat.ownerId;
        const images = flat.images.map(path => path.replace(/\\/g, "/"));

        const card = document.createElement("div");
        card.className = "flex flex-col md:flex-row bg-white/95 shadow-xl rounded-1xl overflow-hidden hover:shadow-2xl transition duration-300";
        card.dataset.images = JSON.stringify(images);
        card.dataset.currentIndex = 0;

        card.innerHTML = `
          <!-- Image Section -->
          <div class="md:w-1/3 h-fill w-full relative h-[300px] bg-gray-100 overflow-hidden ">
            <img id="flat-img-${index}" src="/${images[0]}" alt="Flat Image"
              class="w-full h-full object-cover transition duration-500 rounded-l-3xl">
            <button onclick="prevImage(${index})"
                    class="absolute left-3 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-70 hover:bg-opacity-100 text-purple-700 p-2 rounded-full shadow-md transition duration-300">
              &#10094;
            </button>
            <button onclick="nextImage(${index})"
                    class="absolute right-3 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-70 hover:bg-opacity-100 text-purple-700 p-2 rounded-full shadow-md transition duration-300">
              &#10095;
            </button>
          </div>

          <!-- Details Section -->
          <div class="flex-1 p-8 flex flex-col justify-between bg-gradient-to-br from-white/90 to-purple-50/80 rounded-r-3xl">
            <div>
              <h2 class="text-2xl font-bold text-purple-700 mb-2">${owner?.firstName ?? "Unknown"} ${owner?.lastName ?? ""}</h2>
              <p class="text-sm text-gray-700 mb-1"><strong>Email:</strong> ${owner?.email ?? "N/A"}</p>
              <p class="text-sm text-gray-700 mb-1"><strong>Flat Address:</strong> ${flat.flataddress}</p>
              <p class="text-sm text-gray-700 mb-1"><strong>Rent:</strong> ‚Çπ ${flat.rent} / month</p>
            </div>
            <div class="mt-6 flex gap-4">
              <button class="flex-1 border border-purple-400 hover:bg-purple-100 text-purple-700 py-2 px-4 rounded-xl font-medium transition duration-300" onclick="previewbtn(${index})">
                Preview
              </button>
              <button class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-xl font-medium transition duration-300" onclick="contactOwner(${index})">
                Contact Owner
              </button>
            </div>
          </div>
        `;
        container.prepend(card);
      });
    })
    .catch(error => console.error("Error fetching flats data:", error));

    function previewbtn(index) {
      const flat = flatsData[index];
      alert(`Previewing flat at ${flat.flataddress} with rent ‚Çπ${flat.rent}`);
    }

    function contactOwner(index) {
      const flat = flatsData[index];
      const owner = flat.ownerId || {};
      const modal = document.getElementById("ownerModal");
      const details = document.getElementById("ownerDetails");
      details.innerHTML = `
        <p><strong>Name:</strong> ${owner.firstName ?? "Unknown"} ${owner.lastName ?? ""}</p>
        <p><strong>Email:</strong> ${owner.email ?? "N/A"}</p>
        <p><strong>Phone:</strong> ${owner.number ?? "N/A"}</p>
        <p><strong>Flat Address:</strong> ${flat.flataddress}</p>
        <p><strong>Rent:</strong> ‚Çπ ${flat.rent} / month</p>
      `;
      modal.classList.remove("hidden");
    }

    function closeModal() {
      document.getElementById("ownerModal").classList.add("hidden");
    }

    function prevImage(index) {
      const card = document.querySelectorAll("#flatsContainer > div")[index];
      const images = JSON.parse(card.dataset.images);
      let currentIndex = parseInt(card.dataset.currentIndex);
      currentIndex = (currentIndex - 1 + images.length) % images.length;
      document.getElementById(`flat-img-${index}`).src = "/" + images[currentIndex];
      card.dataset.currentIndex = currentIndex;
    }

    function nextImage(index) {
      const card = document.querySelectorAll("#flatsContainer > div")[index];
      const images = JSON.parse(card.dataset.images);
      let currentIndex = parseInt(card.dataset.currentIndex);
      currentIndex = (currentIndex + 1) % images.length;
      document.getElementById(`flat-img-${index}`).src = "/" + images[currentIndex];
      card.dataset.currentIndex = currentIndex;
    }
  </script>
</body>

</html>
